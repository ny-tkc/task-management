<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskProgress Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#4f46e5',
              secondary: '#64748b',
              success: '#10b981',
              warning: '#f59e0b',
              danger: '#ef4444',
            }
          }
        }
      }
    </script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
      }
    </style>
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0?dev",
        "react-dom": "https://esm.sh/react-dom@18.2.0?dev&deps=react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?dev&deps=react@18.2.0",
        "react-router-dom": "https://esm.sh/react-router-dom@6.22.3?dev&deps=react@18.2.0,react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?dev&deps=react@18.2.0"
      }
    }
    </script>
  <link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module" data-presets="react,typescript">
      import React, { useState, useEffect, useContext, useReducer, createContext } from 'react';
      import ReactDOM from 'react-dom/client';
      import { HashRouter, Routes, Route, NavLink, useLocation, Link, useNavigate, useParams } from 'react-router-dom';
      import { 
        LayoutDashboard, ListTodo, Database, FileOutput, Menu, X, 
        AlertCircle, CheckCircle2, Clock, ArrowRight, Plus, Search, 
        Calendar, Filter, Archive, ArrowLeft, CheckCircle, Trash2, 
        Edit3, Download, FileText 
      } from 'lucide-react';

      // --- Types ---
      type TaskCategory = '研修' | 'TPS' | 'その他';

      interface Partner {
        id: string;
        code: string;
        name: string;
      }

      interface RecurringTask {
        id: string;
        title: string;
        category: TaskCategory;
        triggerMonth: number;
        description?: string;
      }

      interface TaskAssignment {
        partnerId: string;
        completed: boolean;
        completedAt?: string;
      }

      interface Task {
        id: string;
        title: string;
        category: TaskCategory;
        deadline: string;
        assignments: TaskAssignment[];
        createdAt: string;
        archived: boolean;
      }

      interface AppState {
        partners: Partner[];
        tasks: Task[];
        recurringTasks: RecurringTask[];
      }

      type Action =
        | { type: 'ADD_PARTNER'; payload: Partner }
        | { type: 'UPDATE_PARTNER'; payload: Partner }
        | { type: 'DELETE_PARTNER'; payload: string }
        | { type: 'ADD_TASK'; payload: Task }
        | { type: 'UPDATE_TASK'; payload: Task }
        | { type: 'DELETE_TASK'; payload: string }
        | { type: 'TOGGLE_ASSIGNMENT'; payload: { taskId: string; partnerId: string } }
        | { type: 'ARCHIVE_TASK'; payload: string }
        | { type: 'ADD_RECURRING'; payload: RecurringTask }
        | { type: 'DELETE_RECURRING'; payload: string };

      // --- Components ---
      const ProgressBar = ({ current, total }) => {
        const percentage = total === 0 ? 0 : Math.round((current / total) * 100);
        
        let colorClass = 'bg-primary';
        if (percentage === 100) colorClass = 'bg-success';
        else if (percentage < 30) colorClass = 'bg-warning';

        return (
          <div className="w-full">
            <div className="flex justify-between text-xs mb-1 font-medium text-gray-600">
              <span>{percentage}% 完了</span>
              <span>{current} / {total} 件</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
              <div 
                className={`h-2.5 rounded-full transition-all duration-500 ease-out ${colorClass}`} 
                style={{ width: `${percentage}%` }}
              ></div>
            </div>
          </div>
        );
      };

      // --- Context ---
      const initialState = {
        partners: [],
        tasks: [],
        recurringTasks: [],
      };

      const STORAGE_KEY = 'task_progress_app_v1';

      const reducer = (state, action) => {
        switch (action.type) {
          case 'ADD_PARTNER':
            const newPartners = [...state.partners, action.payload].sort((a, b) => a.code.localeCompare(b.code));
            return { ...state, partners: newPartners };
          case 'UPDATE_PARTNER':
            return {
              ...state,
              partners: state.partners.map(p => p.id === action.payload.id ? action.payload : p).sort((a, b) => a.code.localeCompare(b.code))
            };
          case 'DELETE_PARTNER':
            return { ...state, partners: state.partners.filter(p => p.id !== action.payload) };
            
          case 'ADD_TASK':
            return { ...state, tasks: [action.payload, ...state.tasks] };
          case 'UPDATE_TASK':
            return { ...state, tasks: state.tasks.map(t => t.id === action.payload.id ? action.payload : t) };
          case 'DELETE_TASK':
            return { ...state, tasks: state.tasks.filter(t => t.id !== action.payload) };
          case 'TOGGLE_ASSIGNMENT':
            return {
              ...state,
              tasks: state.tasks.map(task => {
                if (task.id !== action.payload.taskId) return task;
                const newAssignments = task.assignments.map(a => {
                  if (a.partnerId !== action.payload.partnerId) return a;
                  return {
                    ...a,
                    completed: !a.completed,
                    completedAt: !a.completed ? new Date().toISOString() : undefined
                  };
                });
                return { ...task, assignments: newAssignments };
              })
            };
          case 'ARCHIVE_TASK':
            return {
              ...state,
              tasks: state.tasks.map(t => t.id === action.payload ? { ...t, archived: true } : t)
            };

          case 'ADD_RECURRING':
            return { ...state, recurringTasks: [...state.recurringTasks, action.payload] };
          case 'DELETE_RECURRING':
            return { ...state, recurringTasks: state.recurringTasks.filter(r => r.id !== action.payload) };

          default:
            return state;
        }
      };

      const AppContext = createContext({ state: initialState, dispatch: () => null });

      const AppProvider = ({ children }) => {
        const [state, dispatch] = useReducer(reducer, initialState, (initial) => {
          try {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : initial;
          } catch (e) {
            console.error("Failed to load state", e);
            return initial;
          }
        });

        useEffect(() => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }, [state]);

        return (
          <AppContext.Provider value={{ state, dispatch }}>
            {children}
          </AppContext.Provider>
        );
      };

      const useApp = () => useContext(AppContext);

      // --- Pages ---
      
      // Dashboard
      const Dashboard = () => {
        const { state } = useApp();
        const { tasks } = state;

        const activeTasks = tasks.filter(t => !t.archived);
        const totalActive = activeTasks.length;
        
        const urgentTasks = activeTasks.filter(task => {
          const total = task.assignments.length;
          const completed = task.assignments.filter(a => a.completed).length;
          if (total === completed) return false;
          
          const daysUntil = Math.ceil((new Date(task.deadline).getTime() - new Date().getTime()) / (1000 * 3600 * 24));
          return daysUntil <= 7;
        }).sort((a, b) => new Date(a.deadline).getTime() - new Date(b.deadline).getTime());

        const recentTasks = [...activeTasks]
          .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
          .slice(0, 5);

        return (
          <div className="space-y-6">
            <header className="mb-8">
              <h1 className="text-3xl font-bold text-gray-800">ダッシュボード</h1>
              <p className="text-gray-500 mt-1">タスクの進捗状況と期限の確認ができます</p>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div className="flex items-center space-x-4">
                  <div className="p-3 bg-blue-100 text-blue-600 rounded-full">
                    <CheckCircle2 size={24} />
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">進行中のタスク</p>
                    <p className="text-2xl font-bold text-gray-800">{totalActive}</p>
                  </div>
                </div>
              </div>
              
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div className="flex items-center space-x-4">
                  <div className="p-3 bg-red-100 text-red-600 rounded-full">
                    <AlertCircle size={24} />
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">期限切れ・直前</p>
                    <p className="text-2xl font-bold text-gray-800">{urgentTasks.length}</p>
                  </div>
                </div>
              </div>

              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div className="flex items-center space-x-4">
                  <div className="p-3 bg-green-100 text-green-600 rounded-full">
                    <Clock size={24} />
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">全パートナー数</p>
                    <p className="text-2xl font-bold text-gray-800">{state.partners.length}</p>
                  </div>
                </div>
              </div>
            </div>

            {urgentTasks.length > 0 && (
              <section>
                <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                  <AlertCircle className="text-red-500 mr-2" size={20} />
                  要注意タスク（期限間近）
                </h2>
                <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                  {urgentTasks.map(task => {
                    const completedCount = task.assignments.filter(a => a.completed).length;
                    return (
                      <Link to={`/tasks/${task.id}`} key={task.id} className="block group">
                        <div className="bg-white p-5 rounded-lg border border-red-200 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex justify-between items-start mb-2">
                            <span className="bg-red-100 text-red-800 text-xs px-2 py-1 rounded font-medium">
                              あと {Math.ceil((new Date(task.deadline).getTime() - new Date().getTime()) / (1000 * 3600 * 24))} 日
                            </span>
                            <span className="text-xs text-gray-500">{task.category}</span>
                          </div>
                          <h3 className="font-bold text-gray-800 mb-3 group-hover:text-primary transition-colors truncate">
                            {task.title}
                          </h3>
                          <ProgressBar current={completedCount} total={task.assignments.length} />
                          <div className="mt-3 text-xs text-gray-500 text-right">
                            期限: {task.deadline}
                          </div>
                        </div>
                      </Link>
                    );
                  })}
                </div>
              </section>
            )}

            <section>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-bold text-gray-800">最新のタスク</h2>
                <Link to="/tasks" className="text-sm text-primary hover:underline flex items-center">
                  全て見る <ArrowRight size={16} className="ml-1" />
                </Link>
              </div>
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm text-gray-600">
                    <thead className="bg-gray-50 text-xs uppercase font-medium">
                      <tr>
                        <th className="px-6 py-4">タスク名</th>
                        <th className="px-6 py-4">区分</th>
                        <th className="px-6 py-4">期限</th>
                        <th className="px-6 py-4 w-1/3">進捗</th>
                        <th className="px-6 py-4"></th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {recentTasks.map(task => {
                        const completedCount = task.assignments.filter(a => a.completed).length;
                        return (
                          <tr key={task.id} className="hover:bg-gray-50">
                            <td className="px-6 py-4 font-medium text-gray-900">{task.title}</td>
                            <td className="px-6 py-4">
                              <span className="inline-block px-2 py-1 text-xs rounded bg-gray-100 text-gray-600">
                                {task.category}
                              </span>
                            </td>
                            <td className="px-6 py-4">{task.deadline}</td>
                            <td className="px-6 py-4">
                              <ProgressBar current={completedCount} total={task.assignments.length} />
                            </td>
                            <td className="px-6 py-4 text-right">
                              <Link to={`/tasks/${task.id}`} className="text-primary hover:text-indigo-800 font-medium text-xs">
                                詳細
                              </Link>
                            </td>
                          </tr>
                        );
                      })}
                      {recentTasks.length === 0 && (
                        <tr>
                          <td colSpan={5} className="px-6 py-8 text-center text-gray-400">
                            タスクがまだありません
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </section>
          </div>
        );
      };

      // TaskList
      const TaskList = () => {
        const { state, dispatch } = useApp();
        const [filter, setFilter] = useState('active');
        const [categoryFilter, setCategoryFilter] = useState('ALL');
        const [isModalOpen, setIsModalOpen] = useState(false);

        const [title, setTitle] = useState('');
        const [category, setCategory] = useState('その他');
        const [deadline, setDeadline] = useState('');
        const [selectedPartners, setSelectedPartners] = useState([]);
        const [useTemplate, setUseTemplate] = useState('');

        const filteredTasks = state.tasks
          .filter(t => (filter === 'active' ? !t.archived : t.archived))
          .filter(t => categoryFilter === 'ALL' || t.category === categoryFilter)
          .sort((a, b) => new Date(a.deadline).getTime() - new Date(b.deadline).getTime());

        const handleCreateTask = (e) => {
          e.preventDefault();
          if (!title || !deadline || selectedPartners.length === 0) return;

          const newTask = {
            id: crypto.randomUUID(),
            title,
            category,
            deadline,
            createdAt: new Date().toISOString(),
            archived: false,
            assignments: selectedPartners.map(pid => ({
              partnerId: pid,
              completed: false
            }))
          };

          dispatch({ type: 'ADD_TASK', payload: newTask });
          setIsModalOpen(false);
          resetForm();
        };

        const resetForm = () => {
          setTitle('');
          setCategory('その他');
          setDeadline('');
          setSelectedPartners([]);
          setUseTemplate('');
        };

        const applyTemplate = (templateId) => {
          const template = state.recurringTasks.find(t => t.id === templateId);
          if (template) {
            setTitle(template.title);
            setCategory(template.category);
            const currentYear = new Date().getFullYear();
            const targetDate = new Date(currentYear, template.triggerMonth - 1, 1);
            setDeadline(targetDate.toISOString().split('T')[0]);
            setSelectedPartners(state.partners.map(p => p.id));
            setUseTemplate(templateId);
          }
        };

        const togglePartnerSelection = (id) => {
          if (selectedPartners.includes(id)) {
            setSelectedPartners(selectedPartners.filter(p => p !== id));
          } else {
            setSelectedPartners([...selectedPartners, id]);
          }
        };

        const selectAllPartners = () => {
          if (selectedPartners.length === state.partners.length) {
            setSelectedPartners([]);
          } else {
            setSelectedPartners(state.partners.map(p => p.id));
          }
        };

        return (
          <div>
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
              <div>
                <h1 className="text-3xl font-bold text-gray-800">タスク管理</h1>
                <p className="text-gray-500">全ての業務タスクを一元管理します</p>
              </div>
              <button 
                onClick={() => { resetForm(); setIsModalOpen(true); }}
                className="flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-indigo-700 transition shadow-sm"
              >
                <Plus size={20} className="mr-2" />
                新規タスク登録
              </button>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
              <div className="flex gap-2">
                <button 
                  onClick={() => setFilter('active')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'active' ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                >
                  進行中
                </button>
                <button 
                  onClick={() => setFilter('archived')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition ${filter === 'archived' ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                >
                  完了済み・アーカイブ
                </button>
              </div>

              <div className="flex items-center gap-2">
                <Filter size={18} className="text-gray-400" />
                <select 
                  value={categoryFilter}
                  onChange={(e) => setCategoryFilter(e.target.value)}
                  className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block p-2"
                >
                  <option value="ALL">全ての区分</option>
                  <option value="研修">研修</option>
                  <option value="TPS">TPS</option>
                  <option value="その他">その他</option>
                </select>
              </div>
            </div>

            <div className="grid gap-4">
              {filteredTasks.length === 0 && (
                  <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                      <p className="text-gray-500">表示するタスクがありません</p>
                  </div>
              )}
              {filteredTasks.map(task => {
                const completedCount = task.assignments.filter(a => a.completed).length;
                const isComplete = completedCount === task.assignments.length && task.assignments.length > 0;

                return (
                  <Link to={`/tasks/${task.id}`} key={task.id} className="block">
                    <div className={`bg-white p-6 rounded-xl border transition hover:shadow-md ${isComplete && filter === 'active' ? 'border-green-200 bg-green-50/30' : 'border-gray-200'}`}>
                      <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                              <span className={`text-xs px-2 py-1 rounded font-medium ${
                                  task.category === '研修' ? 'bg-blue-100 text-blue-700' :
                                  task.category === 'TPS' ? 'bg-purple-100 text-purple-700' :
                                  'bg-gray-100 text-gray-700'
                              }`}>
                                  {task.category}
                              </span>
                              {task.archived && <span className="text-xs px-2 py-1 rounded bg-gray-200 text-gray-600 flex items-center"><Archive size={12} className="mr-1"/> アーカイブ済</span>}
                          </div>
                          <h3 className="text-lg font-bold text-gray-800">{task.title}</h3>
                          <div className="flex items-center text-sm text-gray-500 mt-1">
                            <Calendar size={14} className="mr-1" />
                            期限: {task.deadline}
                          </div>
                        </div>
                        
                        <div className="w-full md:w-64">
                          <ProgressBar current={completedCount} total={task.assignments.length} />
                        </div>
                      </div>
                    </div>
                  </Link>
                );
              })}
            </div>

            {isModalOpen && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                  <div className="p-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h2 className="text-xl font-bold text-gray-800">新規タスク登録</h2>
                    <button onClick={() => setIsModalOpen(false)} className="text-gray-400 hover:text-gray-600">
                      <Filter className="rotate-45" size={24} />
                      <span className="text-2xl">&times;</span>
                    </button>
                  </div>
                  
                  <form onSubmit={handleCreateTask} className="p-6 space-y-6">
                    {state.recurringTasks.length > 0 && (
                      <div className="bg-indigo-50 p-4 rounded-lg">
                        <label className="block text-sm font-medium text-indigo-900 mb-2">定期タスクから入力（任意）</label>
                        <select 
                          value={useTemplate} 
                          onChange={(e) => applyTemplate(e.target.value)}
                          className="w-full bg-white border border-indigo-200 rounded-md p-2 text-sm focus:ring-primary focus:border-primary"
                        >
                          <option value="">テンプレートを選択...</option>
                          {state.recurringTasks.map(t => (
                            <option key={t.id} value={t.id}>{t.triggerMonth}月 - {t.title}</option>
                          ))}
                        </select>
                      </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">タスク名 <span className="text-red-500">*</span></label>
                        <input 
                          type="text" 
                          required
                          value={title}
                          onChange={(e) => setTitle(e.target.value)}
                          className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-primary focus:border-primary"
                          placeholder="例: 年末調整資料配布"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">区分</label>
                        <select 
                          value={category}
                          onChange={(e) => setCategory(e.target.value)}
                          className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-primary focus:border-primary"
                        >
                          <option value="研修">研修</option>
                          <option value="TPS">TPS</option>
                          <option value="その他">その他</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">期限 <span className="text-red-500">*</span></label>
                      <input 
                        type="date" 
                        required
                        value={deadline}
                        onChange={(e) => setDeadline(e.target.value)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-primary focus:border-primary"
                      />
                    </div>

                    <div>
                      <div className="flex justify-between items-center mb-2">
                        <label className="block text-sm font-medium text-gray-700">対象事務所 ({selectedPartners.length}件選択中) <span className="text-red-500">*</span></label>
                        <button 
                          type="button" 
                          onClick={selectAllPartners}
                          className="text-xs text-primary hover:underline"
                        >
                          {selectedPartners.length === state.partners.length ? '全解除' : '全選択'}
                        </button>
                      </div>
                      <div className="border border-gray-200 rounded-lg max-h-48 overflow-y-auto p-2 bg-gray-50 grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {state.partners.length === 0 && <p className="text-sm text-gray-400 p-2 col-span-2">マスター管理から取引先を登録してください。</p>}
                          {state.partners.map(partner => (
                              <label key={partner.id} className="flex items-center p-2 rounded hover:bg-white transition cursor-pointer">
                                  <input 
                                      type="checkbox"
                                      checked={selectedPartners.includes(partner.id)}
                                      onChange={() => togglePartnerSelection(partner.id)}
                                      className="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                                  />
                                  <span className="ml-2 text-sm text-gray-700 truncate">
                                      <span className="font-mono text-gray-400 mr-1">{partner.code}</span>
                                      {partner.name}
                                  </span>
                              </label>
                          ))}
                      </div>
                    </div>

                    <div className="flex justify-end space-x-3 pt-4 border-t border-gray-100">
                      <button 
                        type="button" 
                        onClick={() => setIsModalOpen(false)}
                        className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                      >
                        キャンセル
                      </button>
                      <button 
                        type="submit" 
                        disabled={selectedPartners.length === 0}
                        className="px-4 py-2 text-white bg-primary rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        登録する
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )}
          </div>
        );
      };

      // TaskDetail
      const TaskDetail = () => {
        const { taskId } = useParams();
        const navigate = useNavigate();
        const { state, dispatch } = useApp();
        const [searchTerm, setSearchTerm] = useState('');
        const [isEditMode, setIsEditMode] = useState(false);
        
        const [editTitle, setEditTitle] = useState('');
        const [editCategory, setEditCategory] = useState('その他');
        const [editDeadline, setEditDeadline] = useState('');

        const task = state.tasks.find(t => t.id === taskId);

        if (!task) {
          return <div className="p-8 text-center">タスクが見つかりません</div>;
        }

        const total = task.assignments.length;
        const completed = task.assignments.filter(a => a.completed).length;
        const isAllComplete = total > 0 && total === completed;

        const filteredAssignments = task.assignments.filter(a => {
          const partner = state.partners.find(p => p.id === a.partnerId);
          if (!partner) return false;
          const query = searchTerm.toLowerCase();
          return partner.name.toLowerCase().includes(query) || partner.code.includes(query);
        }).sort((a, b) => {
          if (a.completed === b.completed) {
              const pA = state.partners.find(p => p.id === a.partnerId);
              const pB = state.partners.find(p => p.id === b.partnerId);
              return (pA?.code || '').localeCompare(pB?.code || '');
          }
          return a.completed ? 1 : -1;
        });

        const handleToggle = (partnerId) => {
          dispatch({
            type: 'TOGGLE_ASSIGNMENT',
            payload: { taskId: task.id, partnerId }
          });
        };

        const handleArchive = () => {
          if (window.confirm('このタスクを完了（アーカイブ）しますか？ダッシュボードから非表示になります。')) {
            dispatch({ type: 'ARCHIVE_TASK', payload: task.id });
            navigate('/tasks');
          }
        };

        const handleDelete = () => {
          if (window.confirm('本当にこのタスクを削除しますか？この操作は取り消せません。')) {
            dispatch({ type: 'DELETE_TASK', payload: task.id });
            navigate('/tasks');
          }
        };

        const startEdit = () => {
          setEditTitle(task.title);
          setEditCategory(task.category);
          setEditDeadline(task.deadline);
          setIsEditMode(true);
        }

        const saveEdit = () => {
          dispatch({
              type: 'UPDATE_TASK',
              payload: {
                  ...task,
                  title: editTitle,
                  category: editCategory,
                  deadline: editDeadline
              }
          });
          setIsEditMode(false);
        }

        return (
          <div className="space-y-6">
            <button onClick={() => navigate(-1)} className="flex items-center text-gray-500 hover:text-gray-800 transition">
              <ArrowLeft size={20} className="mr-1" />
              戻る
            </button>

            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-8">
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div className="flex-1 w-full">
                  {isEditMode ? (
                      <div className="space-y-3 bg-gray-50 p-4 rounded-lg border border-indigo-100">
                          <input 
                              type="text" 
                              value={editTitle}
                              onChange={(e) => setEditTitle(e.target.value)}
                              className="w-full text-xl font-bold border-gray-300 rounded focus:ring-primary"
                          />
                          <div className="flex gap-2">
                              <select 
                                  value={editCategory}
                                  onChange={(e) => setEditCategory(e.target.value)}
                                  className="text-sm border-gray-300 rounded focus:ring-primary"
                              >
                                  <option value="研修">研修</option>
                                  <option value="TPS">TPS</option>
                                  <option value="その他">その他</option>
                              </select>
                              <input 
                                  type="date"
                                  value={editDeadline}
                                  onChange={(e) => setEditDeadline(e.target.value)}
                                  className="text-sm border-gray-300 rounded focus:ring-primary"
                              />
                          </div>
                          <div className="flex gap-2 justify-end">
                              <button onClick={() => setIsEditMode(false)} className="px-3 py-1 text-sm bg-white border rounded">キャンセル</button>
                              <button onClick={saveEdit} className="px-3 py-1 text-sm bg-primary text-white rounded">保存</button>
                          </div>
                      </div>
                  ) : (
                      <>
                          <div className="flex items-center gap-3 mb-2">
                              <span className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-medium">{task.category}</span>
                              {task.archived && <span className="px-2 py-1 rounded bg-yellow-100 text-yellow-800 text-xs font-medium">アーカイブ済</span>}
                          </div>
                          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">{task.title}</h1>
                          <div className="flex items-center text-gray-500">
                              <span className="mr-4">期限: {task.deadline}</span>
                          </div>
                      </>
                  )}
                </div>

                <div className="flex gap-2">
                  {!isEditMode && !task.archived && (
                       <button onClick={startEdit} className="p-2 text-gray-500 hover:bg-gray-100 rounded-lg tooltip" title="編集">
                          <Edit3 size={20} />
                       </button>
                  )}
                  {!task.archived && (
                      <button 
                      onClick={handleArchive}
                      disabled={!isAllComplete}
                      className={`flex items-center px-4 py-2 rounded-lg font-medium transition
                          ${isAllComplete 
                          ? 'bg-success text-white hover:bg-emerald-600 shadow-sm' 
                          : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}
                      >
                      <Archive size={18} className="mr-2" />
                      完了にする
                      </button>
                  )}
                   <button onClick={handleDelete} className="p-2 text-red-400 hover:bg-red-50 rounded-lg" title="削除">
                      <Trash2 size={20} />
                   </button>
                </div>
              </div>

              <div className="mb-8">
                <ProgressBar current={completed} total={total} />
              </div>

              <div>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold text-gray-800">進捗チェックリスト</h2>
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={16} />
                    <input 
                      type="text" 
                      placeholder="事務所を検索..." 
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 w-48 md:w-64"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {filteredAssignments.map(assignment => {
                    const partner = state.partners.find(p => p.id === assignment.partnerId);
                    if (!partner) return null;

                    return (
                      <div 
                        key={assignment.partnerId}
                        onClick={() => handleToggle(assignment.partnerId)}
                        className={`
                          cursor-pointer p-4 rounded-lg border flex items-center justify-between transition group select-none
                          ${assignment.completed 
                            ? 'bg-gray-50 border-gray-200 opacity-75' 
                            : 'bg-white border-gray-200 hover:border-primary hover:shadow-sm'
                          }
                        `}
                      >
                        <div className="flex-1 min-w-0 pr-3">
                          <p className="text-xs text-gray-400 font-mono mb-0.5">{partner.code}</p>
                          <p className={`font-medium truncate ${assignment.completed ? 'text-gray-500 line-through' : 'text-gray-800'}`}>
                            {partner.name}
                          </p>
                        </div>
                        <div className={`
                          w-6 h-6 rounded-full flex items-center justify-center border transition-colors
                          ${assignment.completed ? 'bg-success border-success text-white' : 'border-gray-300 group-hover:border-primary'}
                        `}>
                          {assignment.completed && <CheckCircle size={16} />}
                        </div>
                      </div>
                    );
                  })}
                  {filteredAssignments.length === 0 && (
                      <div className="col-span-full py-8 text-center text-gray-400">
                          該当する事務所がありません
                      </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Masters
      const Masters = () => {
        const [activeTab, setActiveTab] = useState('partners');
        
        return (
          <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-6">マスター管理</h1>
            
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden min-h-[600px] flex flex-col">
              <div className="flex border-b border-gray-100">
                <button
                  onClick={() => setActiveTab('partners')}
                  className={`flex-1 py-4 text-center font-medium transition ${activeTab === 'partners' ? 'text-primary border-b-2 border-primary bg-indigo-50/50' : 'text-gray-500 hover:bg-gray-50'}`}
                >
                  取引先情報
                </button>
                <button
                  onClick={() => setActiveTab('recurring')}
                  className={`flex-1 py-4 text-center font-medium transition ${activeTab === 'recurring' ? 'text-primary border-b-2 border-primary bg-indigo-50/50' : 'text-gray-500 hover:bg-gray-50'}`}
                >
                  定期タスク設定
                </button>
              </div>

              <div className="p-6 flex-1 bg-gray-50/30">
                {activeTab === 'partners' ? <PartnerMaster /> : <RecurringMaster />}
              </div>
            </div>
          </div>
        );
      };

      const PartnerMaster = () => {
        const { state, dispatch } = useApp();
        const [isAdding, setIsAdding] = useState(false);
        const [newCode, setNewCode] = useState('');
        const [newName, setNewName] = useState('');

        const handleSubmit = (e) => {
          e.preventDefault();
          if (newCode.length !== 5) {
            alert('コードは5桁で入力してください');
            return;
          }
          dispatch({
            type: 'ADD_PARTNER',
            payload: { id: crypto.randomUUID(), code: newCode, name: newName }
          });
          setNewCode('');
          setNewName('');
          setIsAdding(false);
        };

        const handleDelete = (id) => {
          if (window.confirm('削除しますか？')) {
            dispatch({ type: 'DELETE_PARTNER', payload: id });
          }
        };

        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <p className="text-sm text-gray-500">取引先コード順に自動整列されます。</p>
              <button 
                onClick={() => setIsAdding(true)} 
                className="flex items-center px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 shadow-sm"
              >
                <Plus size={16} className="mr-2" /> 追加
              </button>
            </div>

            {isAdding && (
              <form onSubmit={handleSubmit} className="bg-white p-4 rounded-lg shadow-sm border border-indigo-100 flex flex-col md:flex-row gap-3 items-end md:items-center">
                <div>
                  <label className="block text-xs text-gray-500 mb-1">コード (5桁)</label>
                  <input 
                    type="text" 
                    value={newCode}
                    onChange={(e) => setNewCode(e.target.value)}
                    className="border p-2 rounded w-24 text-sm"
                    maxLength={5}
                    placeholder="00001"
                    required 
                  />
                </div>
                <div className="flex-1 w-full">
                  <label className="block text-xs text-gray-500 mb-1">事務所名</label>
                  <input 
                    type="text" 
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                    className="border p-2 rounded w-full text-sm"
                    placeholder="〇〇会計事務所"
                    required 
                  />
                </div>
                <div className="flex gap-2">
                  <button type="submit" className="bg-primary text-white p-2 rounded text-sm">保存</button>
                  <button type="button" onClick={() => setIsAdding(false)} className="bg-gray-100 p-2 rounded text-sm">キャンセル</button>
                </div>
              </form>
            )}

            <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
              <table className="w-full text-sm text-left">
                <thead className="bg-gray-50 text-gray-500 font-medium border-b border-gray-200">
                  <tr>
                    <th className="px-4 py-3 w-24">コード</th>
                    <th className="px-4 py-3">事務所名</th>
                    <th className="px-4 py-3 w-20 text-center">操作</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {state.partners.map(p => (
                    <tr key={p.id} className="hover:bg-gray-50 group">
                      <td className="px-4 py-3 font-mono text-gray-600">{p.code}</td>
                      <td className="px-4 py-3">{p.name}</td>
                      <td className="px-4 py-3 text-center">
                        <button onClick={() => handleDelete(p.id)} className="text-gray-300 hover:text-red-500 transition">
                          <Trash2 size={16} />
                        </button>
                      </td>
                    </tr>
                  ))}
                  {state.partners.length === 0 && (
                      <tr><td colSpan={3} className="px-4 py-8 text-center text-gray-400">データがありません</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      const RecurringMaster = () => {
        const { state, dispatch } = useApp();
        const [isAdding, setIsAdding] = useState(false);
        
        const [title, setTitle] = useState('');
        const [category, setCategory] = useState('その他');
        const [month, setMonth] = useState(1);

        const handleSubmit = (e) => {
          e.preventDefault();
          const newTask = {
            id: crypto.randomUUID(),
            title,
            category,
            triggerMonth: month,
          };
          dispatch({ type: 'ADD_RECURRING', payload: newTask });
          setIsAdding(false);
          setTitle('');
          setCategory('その他');
          setMonth(1);
        };

        const handleDelete = (id) => {
            if (window.confirm('削除しますか？')) {
              dispatch({ type: 'DELETE_RECURRING', payload: id });
            }
        }

        const sortedTasks = [...state.recurringTasks].sort((a, b) => a.triggerMonth - b.triggerMonth);

        return (
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <p className="text-sm text-gray-500">毎年発生する定期タスクのテンプレートを登録します。</p>
              <button 
                onClick={() => setIsAdding(true)} 
                className="flex items-center px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 shadow-sm"
              >
                <Plus size={16} className="mr-2" /> 追加
              </button>
            </div>

            {isAdding && (
              <form onSubmit={handleSubmit} className="bg-white p-4 rounded-lg shadow-sm border border-indigo-100 space-y-3">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                   <div>
                      <label className="block text-xs text-gray-500 mb-1">発生時期 (月)</label>
                      <select 
                          value={month} 
                          onChange={e => setMonth(parseInt(e.target.value))}
                          className="w-full border p-2 rounded text-sm"
                      >
                          {Array.from({length: 12}, (_, i) => i + 1).map(m => (
                              <option key={m} value={m}>{m}月</option>
                          ))}
                      </select>
                   </div>
                   <div>
                      <label className="block text-xs text-gray-500 mb-1">区分</label>
                      <select 
                          value={category} 
                          onChange={e => setCategory(e.target.value)}
                          className="w-full border p-2 rounded text-sm"
                      >
                          <option value="研修">研修</option>
                          <option value="TPS">TPS</option>
                          <option value="その他">その他</option>
                      </select>
                   </div>
                   <div className="md:col-span-2">
                      <label className="block text-xs text-gray-500 mb-1">タスク名</label>
                      <input 
                          type="text" 
                          value={title}
                          onChange={e => setTitle(e.target.value)}
                          className="w-full border p-2 rounded text-sm"
                          required
                      />
                   </div>
                </div>
                <div className="flex justify-end gap-2 pt-2">
                  <button type="button" onClick={() => setIsAdding(false)} className="px-3 py-1 text-sm text-gray-600">キャンセル</button>
                  <button type="submit" className="px-3 py-1 text-sm bg-primary text-white rounded">保存</button>
                </div>
              </form>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {sortedTasks.map(task => (
                  <div key={task.id} className="bg-white p-4 rounded-lg border border-gray-200 relative group">
                      <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                           <button onClick={() => handleDelete(task.id)} className="text-gray-400 hover:text-red-500 p-1">
                              <Trash2 size={16} />
                           </button>
                      </div>
                      <div className="flex items-center gap-2 mb-2">
                          <span className="bg-indigo-50 text-indigo-700 text-xs font-bold px-2 py-1 rounded">{task.triggerMonth}月</span>
                          <span className="text-xs text-gray-500 border border-gray-200 px-2 py-0.5 rounded">{task.category}</span>
                      </div>
                      <h3 className="font-bold text-gray-800">{task.title}</h3>
                  </div>
              ))}
               {sortedTasks.length === 0 && (
                  <div className="col-span-full py-8 text-center text-gray-400">データがありません</div>
               )}
            </div>
          </div>
        );
      };

      // Export
      const Export = () => {
        const { state } = useApp();

        const handleDownloadIncomplete = () => {
          const activeTasks = state.tasks.filter(t => !t.archived);
          let csvContent = "data:text/csv;charset=utf-8,";
          csvContent += "\uFEFF"; 
          csvContent += "コード,事務所名,タスク名\n";

          activeTasks.forEach(task => {
            task.assignments.forEach(assignment => {
              if (!assignment.completed) {
                const partner = state.partners.find(p => p.id === assignment.partnerId);
                if (partner) {
                  const row = `"${partner.code}","${partner.name}","${task.title}"`;
                  csvContent += row + "\n";
                }
              }
            });
          });

          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          const dateStr = new Date().toISOString().split('T')[0];
          link.setAttribute("download", `未完了タスク一覧_${dateStr}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        return (
          <div className="space-y-6">
            <header>
              <h1 className="text-3xl font-bold text-gray-800">データ出力</h1>
              <p className="text-gray-500 mt-1">タスクや進捗状況をCSV形式でダウンロードできます。</p>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between h-full">
                <div>
                  <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-orange-600 mb-4">
                    <FileText size={24} />
                  </div>
                  <h2 className="text-xl font-bold text-gray-800 mb-2">未完了タスク切り出し</h2>
                  <p className="text-gray-600 text-sm mb-4">
                    現在進行中のタスクの中で、未完了となっている事務所一覧を出力します。<br/>
                    リスト作成やリマインド連絡等に活用できます。
                  </p>
                  <div className="bg-gray-50 p-3 rounded text-xs text-gray-500 font-mono mb-4">
                      出力項目: コード, 事務所名, タスク名
                  </div>
                </div>
                <button 
                  onClick={handleDownloadIncomplete}
                  className="w-full flex items-center justify-center px-4 py-3 bg-white border-2 border-primary text-primary font-bold rounded-lg hover:bg-primary hover:text-white transition group"
                >
                  <Download size={20} className="mr-2 group-hover:animate-bounce" />
                  CSVダウンロード
                </button>
              </div>

              <div className="bg-gray-50 p-6 rounded-xl border border-dashed border-gray-300 flex flex-col items-center justify-center text-center opacity-75">
                <p className="font-bold text-gray-400">その他のレポート</p>
                <p className="text-sm text-gray-400 mt-1">将来的な機能拡張用エリア</p>
              </div>
            </div>
          </div>
        );
      };

      // --- Navigation & App ---
      const Navigation = () => {
        const [isOpen, setIsOpen] = useState(false);
        const location = useLocation();

        const links = [
          { to: '/', icon: LayoutDashboard, label: 'ダッシュボード' },
          { to: '/tasks', icon: ListTodo, label: 'タスク管理' },
          { to: '/masters', icon: Database, label: 'マスター管理' },
          { to: '/export', icon: FileOutput, label: 'データ出力' },
        ];

        const activeClass = "bg-primary text-white";
        const inactiveClass = "text-gray-600 hover:bg-gray-100";

        return (
          <>
            <div className="md:hidden flex items-center justify-between p-4 bg-white shadow-sm sticky top-0 z-20">
              <h1 className="text-xl font-bold text-gray-800">TaskProgress Pro</h1>
              <button onClick={() => setIsOpen(!isOpen)} className="p-2 rounded-md hover:bg-gray-100">
                {isOpen ? <X size={24} /> : <Menu size={24} />}
              </button>
            </div>

            {isOpen && (
              <div 
                className="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"
                onClick={() => setIsOpen(false)}
              />
            )}

            <aside className={`
              fixed md:static inset-y-0 left-0 z-40 w-64 bg-white border-r border-gray-200 transform transition-transform duration-200 ease-in-out
              ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0
            `}>
              <div className="p-6 border-b border-gray-100 hidden md:block">
                <h1 className="text-2xl font-bold text-primary">TaskProgress Pro</h1>
              </div>
              <nav className="p-4 space-y-2">
                {links.map((link) => (
                  <NavLink
                    key={link.to}
                    to={link.to}
                    onClick={() => setIsOpen(false)}
                    className={({ isActive }) => `
                      flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors
                      ${isActive ? activeClass : inactiveClass}
                    `}
                  >
                    <link.icon size={20} />
                    <span className="font-medium">{link.label}</span>
                  </NavLink>
                ))}
              </nav>
            </aside>
          </>
        );
      };

      const App = () => {
        return (
          <AppProvider>
            <HashRouter>
              <div className="flex h-screen bg-gray-50 flex-col md:flex-row overflow-hidden">
                <Navigation />
                <main className="flex-1 overflow-y-auto p-4 md:p-8">
                  <div className="max-w-6xl mx-auto">
                    <Routes>
                      <Route path="/" element={<Dashboard />} />
                      <Route path="/tasks" element={<TaskList />} />
                      <Route path="/tasks/:taskId" element={<TaskDetail />} />
                      <Route path="/masters" element={<Masters />} />
                      <Route path="/export" element={<Export />} />
                    </Routes>
                  </div>
                </main>
              </div>
            </HashRouter>
          </AppProvider>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>